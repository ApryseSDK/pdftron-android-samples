package com.pdftron.realtimecollaborationws

import android.content.Context
import android.net.Uri
import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity
import com.pdftron.collab.ui.viewer.CollabViewerBuilder
import com.pdftron.collab.ui.viewer.CollabViewerTabHostFragment
import com.pdftron.pdf.config.ToolManagerBuilder
import com.pdftron.pdf.config.ViewerConfig
import java.util.*

class MainActivity : AppCompatActivity() {

    private val DEFAULT_FILE_URL =
        "https://pdftron.s3.amazonaws.com/downloads/pl/webviewer-demo.pdf"

    private lateinit var mPdfViewCtrlTabHostFragment: CollabViewerTabHostFragment

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        mPdfViewCtrlTabHostFragment =
            createPdfViewerFragment(this, Uri.parse(DEFAULT_FILE_URL), getViewerConfig())

        mPdfViewCtrlTabHostFragment.addCollabHostListener(object :
            CollabViewerTabHostFragment.CollabTabHostListener {
            override fun onNavButtonPressed() {
                finish()
            }

            override fun onTabDocumentLoaded(p0: String?) {
                handleTabDocumentLoaded(p0!!)
            }

        })

        val ft = supportFragmentManager.beginTransaction()
        ft.replace(R.id.fragment_container, mPdfViewCtrlTabHostFragment, null)
        ft.commit()
    }

    fun handleTabDocumentLoaded(tag: String) {

        val collabManager = mPdfViewCtrlTabHostFragment.collabManager
        collabManager!!.setCurrentUser(UUID.randomUUID().toString(), "test")
        collabManager.setCurrentDocument(tag)

        val testXfdf = "<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n" +
                "    <xfdf xmlns=\"http://ns.adobe.com/xfdf/\" xml:space=\"preserve\">\n" +
                "    <fields/>\n" +
                "    <add>\n" +
                "    <ink page=\"0\" rect=\"-1,-1,38.438596,37\" color=\"#E44234\" flags=\"print\" name=\"67a5080a-2153-5667-5635-9619d5118df5\" title=\"emiliogenesio@gmail.com\" subject=\"Free hand\" date=\"D:20190910120214+02'00'\" creationdate=\"D:20190910120209+02'00'\">\n" +
                "    <inklist>\n" +
                "      <gesture>15.82,36;15.44,35.61;14.28,34.84;11.96,33.3;10.81,32.91;8.11,31.37;6.18,30.21;3.47,29.05;3.09,28.67;1.93,27.89;1.54,27.12;0.77,26.35;0.77,25.96;0,24.42;0,21.72;0,20.95;0,19.4;0,18.25;0,17.09;0,16.32;0,14.77;0,14;0,12.84;0,12.46;0,11.3;0,10.53;0,9.75;0,9.37;0,8.6;0,5.89;0,5.12;0,3.58;0,3.19;0,2.42;0,1.65;0,0.49;0,0.11;0,0.11;0,0;0,0;0,0;0,0;1.54,0;2.32,0;4.25,0;6.18,0;8.49,0;10.04,0;10.42,0;11.19,0;11.96,0;13.51,0;14.28,0;16.21,0;16.98,0;17.75,0.11;20.46,2.42;21.61,3.19;23.16,4.35;23.93,4.74;24.7,5.12;25.86,5.51;26.63,5.89;27.4,6.28;28.18,6.28;29.33,6.67;30.11,7.44;31.26,8.21;32.81,8.98;33.96,9.75;36.28,10.91;36.67,11.3;37.05,11.3;37.05,11.3;37.05,11.68;37.05,12.46;37.44,13.23;37.44,14.77;37.44,15.16;37.44,15.93;37.44,17.47;37.44,17.86;37.05,18.63;36.67,19.4;35.51,21.33;35.12,22.11;33.58,24.04;32.42,24.81;30.49,26.74;28.95,27.51;26.63,28.67;23.93,29.44;22.39,30.21;21.23,30.6;21.23,30.6;20.84,30.6;20.84,30.6;20.84,30.98;20.46,30.98;20.07,30.98;19.68,31.37;18.91,31.37;17.75,32.14;17.37,32.53;16.6,32.91;16.6,32.91;16.21,32.91;16.21,32.91;16.21,32.91;15.82,33.68;15.82,34.07;15.05,34.46;15.05,34.46;14.67,34.46;14.67,34.46;14.67,34.46;14.67,34.84</gesture>\n" +
                "    </inklist>\n" +
                "  </ink>,<ink style=\"solid\" width=\"1\" color=\"#E44234\" opacity=\"1\" creationdate=\"D:20190910120219+02'00'\" flags=\"print\" date=\"D:20191024080609Z\" name=\"fc21b1e1-aa6a-0669-5070-63aa514c1012\" page=\"0\" rect=\"453.07,258.26,509.74,311.88\" rotation=\"0\" subject=\"Free hand\" title=\"emiliogenesio@gmail.com\">\n" +
                "    <inklist>\n" +
                "      <gesture>475.32,311.38;473.58,311.38;473.14,311.38;471.84,311.38;470.97,311.38;468.79,310.95;467.49,310.51;464.01,309.64;461.84,309.21;458.36,307.91;457.05,307.47;455.75,306.17;455.31,306.17;454.88,305.73;454.44,304.86;454.01,304.43;453.57,303.99;453.57,303.12;453.57,302.69;453.57,302.25;453.57,300.51;453.57,300.08;454.44,299.21;454.88,298.34;455.75,297.47;456.62,296.6;459.23,295.29;462.27,294.42;469.66,293.12;472.27,293.12;479.23,292.25;481.41,291.82;484.88,291.82;485.75,291.82;486.62,291.82;487.49,291.82;488.36,291.82;489.67,291.82;490.97,291.82;491.41,291.82;491.84,291.82;493.15,292.25;494.02,292.25;494.89,292.68;496.63,293.12;498.37,293.55;499.24,293.99;500.97,294.42;501.84,294.86;503.15,295.29;503.58,295.73;504.45,296.6;504.89,297.03;505.76,297.47;506.19,297.9;507.06,298.34;507.5,298.77;507.93,299.64;508.37,300.08;508.8,300.51;508.8,300.95;509.24,301.38;509.24,301.82;509.24,302.25;509.24,302.69;509.24,303.12;508.8,303.99;508.8,303.99;508.37,304.86;507.06,305.73;506.19,306.17;505.32,306.6;503.15,307.04;502.28,307.47;500.54,307.47;500.11,307.91;498.8,307.91;497.5,307.91;494.89,308.78;493.58,308.78;490.97,308.78;489.67,308.78;488.8,309.21;487.49,309.21;486.62,309.21;486.19,309.21;485.75,309.21;485.32,309.21;484.01,309.21;484.01,309.21;482.71,309.21;482.28,309.21;481.84,309.21;481.41,309.21;481.41,309.21;480.54,309.21;480.1,309.64;478.36,309.64;477.49,309.64;475.32,309.64;474.45,309.64;473.58,309.64;473.14,309.64;473.14,309.64;473.14,309.64;472.71,310.08;472.27,310.08;471.84,310.51;471.84,310.95;471.4,311.38;471.4,311.38;470.53,310.51;470.1,309.21</gesture>\n" +
                "      <gesture>469.23,258.76;469.23,258.76;470.53,261.81;471.4,264.85;474.45,272.25;475.75,275.72;477.49,280.94;477.93,282.68;478.36,284.86;478.36,285.73;478.8,287.47;478.8,287.9;478.8,288.77;478.8,289.21;478.8,289.21;478.8,289.21;477.93,287.47;477.93,287.03;477.49,286.6;477.49,286.6</gesture>\n" +
                "      <gesture>478.36,288.77;477.93,288.34;477.06,287.47;475.32,285.73;474.01,284.86;472.27,283.12;471.4,282.68;471.4,282.68;471.84,283.55;472.71,284.42;473.58,285.29;474.88,286.6;475.32,287.03;476.19,287.47;476.62,287.9;477.06,288.34;477.93,288.77;479.67,289.21;480.1,289.21;480.54,289.21;480.54,289.21;480.97,289.21;481.41,288.77;482.28,287.47;482.28,287.03;483.14,285.29;483.58,285.29;483.58,284.42;483.58,283.99;484.01,283.12;484.01,282.68;484.01,282.25;484.01,282.25;484.01,282.25;484.01,282.25;484.01,281.81;484.01,280.94;484.45,280.51;484.45,280.07;484.45,280.07;483.58,280.51;483.14,280.51;481.84,280.51;480.97,280.94;478.36,281.81;476.62,281.81;474.01,282.25;473.58,282.25;473.14,282.25</gesture>\n" +
                "    </inklist>\n" +
                "  </ink>,<ink color=\"#E44234\" creationdate=\"D:20190910120244+02'00'\" flags=\"print\" date=\"D:20191024142327Z\" name=\"382e5d26-7bd4-309b-7d79-a9bce28936c5\" page=\"0\" rect=\"144.606,44.1316,270.526,79.5264\" rotation=\"0\" subject=\"Free hand\" title=\"emiliogenesio@gmail.com\">\n" +
                "    <inklist>\n" +
                "      <gesture>150.215,79.0264;150.215,76.8684;150.215,73.2939;150.215,70.4277;150.215,63.9869;150.215,61.1207;151.252,56.8213;151.252,53.2303;153.3,46.0647;154.313,45.3564;154.313,44.6316;154.313,44.6316;155.349,44.6316;157.398,45.3564;164.556,46.0647;171.738,47.4979;200.396,49.6558;212.687,50.3641;240.332,51.0889;248.527,51.0889;260.819,48.931;264.916,48.931;269.014,48.2227;269.014,48.2227;269.014,51.7972;269.014,54.6634;270.026,61.829;270.026,66.1283;270.026,70.4277;270.026,71.8608;270.026,73.2939;270.026,73.2939;269.014,74.0022;269.014,74.727;267.977,75.4353;267.977,75.4353;266.965,75.4353;265.929,75.4353;261.832,76.1601;256.722,76.1601;245.466,76.8684;237.271,76.8684;215.772,76.8684;204.493,76.8684;186.055,76.8684;175.835,76.8684;158.41,77.5932;153.3,77.5932;149.203,77.5932;146.118,77.5932;145.106,77.5932;146.118,77.5932</gesture>\n" +
                "    </inklist>\n" +
                "    <apref y=\"80.0895\" x=\"143.106\" gennum=\"0\" objnum=\"20\"/>\n" +
                "  </ink>,<ink page=\"0\" rect=\"576.077731,-0.115546,613,35.804622\" color=\"#E44234\" flags=\"print\" name=\"1f7b7b7b-4b47-4a84-ebd5-b5c7b9dc110f\" title=\"emiliogenesio@gmail.com\" subject=\"Free hand\" date=\"D:20190910120407+02'00'\" creationdate=\"D:20190910120404+02'00'\">\n" +
                "    <inklist>\n" +
                "      <gesture>590.56,27.85;589.69,27.85;589.25,27.41;587.08,26.54;586.21,26.11;584.91,26.11;582.73,25.24;581.43,24.37;580.12,23.5;578.82,22.19;578.38,21.76;577.95,20.89;577.51,19.15;577.08,18.28;577.08,16.11;577.08,15.67;577.08,13.93;577.08,13.5;577.08,12.63;577.08,12.19;577.08,10.89;577.08,10.45;577.51,9.58;577.51,9.15;577.95,8.28;577.95,7.84;578.82,6.97;579.25,6.54;580.99,5.23;581.43,4.8;582.3,3.93;583.17,3.49;584.04,2.62;584.47,2.62;585.34,2.19;586.64,1.75;589.25,1.32;590.56,1.32;592.3,1.32;595.78,1.32;599.69,0.88;600.56,0.88;601.87,0.88;604.47,0.88;605.34,1.32;607.08,1.32;607.95,1.32;610.56,1.75;611.43,1.75;612,2.19;612,2.62;612,3.06;612,3.06;612,3.49;612,3.93;612,4.8;612,4.8;612,6.1;612,6.54;612,7.41;612,8.28;612,8.71;612,10.45;612,12.19;612,13.5;612,14.37;612,15.24;612,15.67;612,16.97;612,17.41;611.87,19.58;611.87,20.02;611.43,20.45;611,21.32;610.56,22.19;609.69,23.06;607.52,24.8;606.21,26.11;604.47,27.85;604.04,28.28;602.74,29.59;602.3,30.02;601.43,30.89;601,31.33;599.69,31.76;598.82,32.2;597.08,33.07;595.78,33.5;594.47,33.93;592.73,34.37;591.43,34.8;590.56,34.8;588.82,34.8;587.95,34.8;586.21,34.8;583.17,34.37;581.86,34.37;580.99,33.93;580.56,33.93;580.56,33.93;580.56,33.93</gesture>\n" +
                "    </inklist>\n" +
                "  </ink>,<ink color=\"#E44234\" creationdate=\"D:20190910120409+02'00'\" flags=\"print\" date=\"D:20191028141646Z\" name=\"1d3a9e36-0451-c25e-39db-ecd219bc9a0b\" page=\"0\" rect=\"4.5,314.043,37.376,343.875\" rotation=\"0\" subject=\"Free hand\" title=\"emiliogenesio@gmail.com\">\n" +
                "    <inklist>\n" +
                "      <gesture>17.68,342.875;14.63,341.575;12.46,341.135;10.72,340.705;5.5,339.395;5.5,338.095;5.5,337.655;5.5,336.355;5.5,334.175;5.5,333.305;5.5,331.565;5.5,331.135;5.5,330.265;5.5,329.395;5.5,328.085;5.5,327.655;5.5,326.345;5.5,325.915;5.5,324.615;5.5,324.175;5.5,322.875;5.5,322.005;5.5,319.825;5.5,318.525;5.5,317.215;5.5,316.785;5.5,316.345;5.5,316.345;5.5,315.915;5.5,315.915;5.5,315.915;6.8,315.475;9.41,315.475;11.59,315.475;15.5,315.475;16.81,315.475;18.11,315.045;19.85,315.045;21.59,315.915;22.89,316.345;23.33,316.785;25.5,317.655;26.37,318.085;27.68,318.525;28.11,318.955;29.85,320.265;30.72,322.005;32.46,324.615;33.77,325.915;34.64,327.655;35.07,328.085;35.94,328.955;35.94,329.825;36.38,331.565;36.38,332.875;36.38,334.615;36.38,335.045;35.94,335.915;35.51,337.225;34.2,339.395;33.77,339.835;32.9,340.265;32.46,341.135;31.59,341.575;30.72,342.445;29.85,342.445;29.42,342.875;28.98,342.875;27.68,342.875;27.24,342.875;25.5,342.875;24.63,342.875;22.89,342.875;22.46,342.875;19.85,342.875;18.55,342.875;15.94,342.875;15.5,342.875;15.07,342.875;15.07,342.875;15.07,342.875</gesture>\n" +
                "    </inklist>\n" +
                "  </ink>,<ink style=\"solid\" width=\"3\" color=\"#FF0000\" opacity=\"1\" creationdate=\"D:20191011170253Z\" flags=\"print\" date=\"D:20191024142305Z\" name=\"-LqvlTpeoCb2P5NTY8rf\" page=\"0\" rect=\"139.875,203.848,406.875,242.512\" rotation=\"0\" title=\"emiliogenesio@gmail.com\">\n" +
                "    <inklist>\n" +
                "      <gesture>162.375,240.261;162,240.261;160.125,240.261;157.125,240.261;152.625,240.637;148.875,240.637;147.75,240.637;147.375,240.261;146.25,239.511;144.75,238.384;143.625,237.258;143.25,236.883;142.875,236.132;142.125,234.63;141.75,233.504;141.75,232.753;141.375,232.002;141.375,230.876;141.375,229.75;141.75,228.999;141.75,227.873;141.75,225.996;142.5,223.368;143.25,220.74;143.625,220.74;144.375,219.614;146.25,217.737;148.875,215.484;151.125,214.358;153.75,213.232;157.125,212.106;160.875,211.355;163.125,211.355;164.625,210.979;165,210.979;166.5,210.979;170.625,210.229;178.5,209.853;186.75,209.102;189.75,208.727;204.75,206.099;212.625,205.348;217.125,205.348;218.625,205.348;219.75,205.724;222.375,205.724;228.375,205.724;234.375,205.724;240,205.724;244.875,205.724;249,205.348;252.375,205.724;255.75,206.099;259.875,206.85;263.25,206.85;266.625,206.475;267.75,206.475;268.125,206.475;268.875,206.85;270.75,206.85;272.625,206.85;274.125,206.85;275.625,206.85;277.5,207.225;279,207.601;281.625,207.976;283.875,208.727;285,209.478;286.5,210.229;287.25,211.73;288,212.857;288.75,213.232;289.125,213.983;289.125,214.734;289.5,215.109;289.875,215.109;290.625,215.484;291.75,215.484;292.875,215.86;295.5,215.86;300.375,215.86;304.5,216.235;309,216.611;312.375,216.611;314.625,216.611;318.375,216.611;323.25,216.235;327,216.235;331.5,216.235;337.125,215.484;342.375,215.484;346.875,215.109;350.625,215.109;354,215.109;357.375,214.734;361.125,214.734;364.875,214.734;368.625,214.358;372.375,214.358;376.5,214.734;379.5,214.734;382.125,215.109;384.375,215.484;386.25,215.86;388.875,216.611;391.125,217.361;394.125,217.737;396.375,218.488;397.875,219.238;399,220.365;400.5,221.116;402.75,222.242;403.875,222.617;404.25,222.993;405,224.494;405,224.87;405.375,225.62;405.375,226.371;404.625,228.248;404.25,229.75;403.5,230.501;402.375,231.627;398.625,233.879;390.375,237.633;386.625,238.76;386.25,238.76;385.125,238.76;384.375,238.384;383.25,238.009;382.875,237.633;381.75,237.258;380.625,236.883;379.125,236.132;376.875,235.756;373.5,235.381;368.625,235.381;365.25,235.006;355.875,234.255;349.875,234.255;343.125,234.255;337.125,234.255;333.75,234.255;330.75,233.879;327.75,233.879;322.875,233.879;316.875,233.504;310.125,233.504;303,233.129;296.625,232.753;291.75,232.378;286.5,232.378;282.375,232.378;280.125,232.378;277.875,232.378;275.625,232.378;273.75,232.378;271.875,232.378;269.25,232.378;266.25,232.378;263.25,232.378;260.25,232.378;258,232.378;255.375,232.378;251.625,232.002;246.75,231.627;242.625,231.627;239.25,231.252;237,230.876;234.375,230.876;231.75,230.876;230.25,230.876;229.5,230.876;226.875,230.876;224.625,231.252;223.5,231.252;222.75,231.252;222.375,231.252;221.625,231.627;220.875,231.627;219.375,231.627;217.875,231.627;216,232.002;214.125,232.002;212.625,232.002;210.75,232.378;209.25,232.378;208.5,232.753;208.125,232.753;208.125,233.129;207,234.255;207,235.006;207,236.132;206.625,237.258;206.625,237.633;205.5,238.384;201.75,239.511;197.25,240.637;193.125,241.012;189.375,241.012;186.75,241.012;185.625,241.012;184.875,241.012;183.75,241.012;181.875,241.012;179.25,241.012;176.625,241.012;175.5,241.012;172.875,241.012;171,241.012;170.25,241.012;169.5,241.012;168.375,240.637;167.25,240.637;165.75,240.637;163.5,240.637;161.625,240.637;161.25,240.637</gesture>\n" +
                "    </inklist>\n" +
                "    <apref y=\"242.888\" x=\"139.875\" gennum=\"0\" objnum=\"24\"/>\n" +
                "  </ink>,<text page=\"0\" rect=\"140.375,223.139,160.375,243.139\" color=\"#FFFF00\" flags=\"print,nozoom,norotate\" name=\"b0c21a4e-1674-508c-5271-f1978bdf03c9\" title=\"emiliogenesio@gmail.com\" subject=\"Comment\" date=\"D:20191024100427+02'00'\" creationdate=\"D:20191024100427+02'00'\" icon=\"Comment\" inreplyto=\"-LqvlTpeoCb2P5NTY8rf\">\n" +
                "    <contents>Some reply</contents>\n" +
                "  </text>,<text page=\"0\" rect=\"139.875,222.512,159.875,242.512\" color=\"#FFFF00\" flags=\"print,nozoom,norotate\" name=\"49c80d66-ee85-30be-71f6-9129d2e33ae5\" title=\"apitest11@gbuilder.com\" subject=\"Comment\" date=\"D:20191028152352+01'00'\" creationdate=\"D:20191028152352+01'00'\" icon=\"Comment\" inreplyto=\"-LqvlTpeoCb2P5NTY8rf\">\n" +
                "    <contents>Some comment\n" +
                "</contents>\n" +
                "  </text>,<ink page=\"0\" rect=\"386.15562,123.472622,430.510086,165.440922\" color=\"#4E7DE9\" flags=\"print\" name=\"8de3534b-934c-9399-8b51-10780af10729\" title=\"apitest11@gbuilder.com\" subject=\"Free hand\" date=\"D:20191028153338+01'00'\" creationdate=\"D:20191028153332+01'00'\">\n" +
                "    <inklist>\n" +
                "      <gesture>394.31,134.61;393.72,132.82;392.52,128.65;391.93,126.26;391.33,124.47;391.33,124.47;391.93,126.86;391.93,128.05;392.52,129.84;393.12,135.21;393.72,138.19;394.31,142.97;394.91,144.16;394.91,145.95;394.91,145.95;395.51,144.16;395.51,142.97;396.7,141.18;397.3,140.58;399.68,137.6;401.47,135.81;403.26,133.42;403.26,133.42;403.86,132.82</gesture>\n" +
                "      <gesture>401.47,137;397.3,136.4;394.91,135.81;390.14,134.61;388.95,134.02;387.16,132.23;387.16,132.23;387.16,132.82;387.75,133.42</gesture>\n" +
                "      <gesture>399.68,153.11;400.28,152.51;401.47,150.12;405.05,144.16;406.84,141.18;409.23,138.19;411.61,134.61;412.81,132.82;413.4,131.03;414,130.44;414,129.84;414,129.84;414,129.84;414,129.24;414,128.65;414,126.86;414,126.86;414.6,126.86</gesture>\n" +
                "      <gesture>400.88,146.54;400.88,146.54;401.47,147.14;401.47,147.74;402.67,148.33;403.86,149.53;407.44,151.32;409.23,151.91;412.81,153.11;414,153.7;415.19,153.7;415.79,153.7;415.79,153.7;415.79,153.11;415.79,150.72;415.19,149.53;414.6,146.54;414,145.95;412.81,144.16;412.21,142.97;411.02,141.77;410.42,141.18;409.82,140.58;409.23,140.58;409.23,139.98</gesture>\n" +
                "      <gesture>418.18,154.9;418.18,154.3;418.18,153.7;420.56,148.33;421.76,145.35;424.74,139.98;425.93,138.79;428.32,135.81;428.91,135.21;428.91,135.21;428.91,135.21;428.91,135.21;429.51,135.21</gesture>\n" +
                "      <gesture>412.81,164.44;411.61,163.84;409.82,162.65;409.23,162.05;409.23,160.86;409.23,160.86;410.42,160.27;411.02,160.27;414.6,160.27;416.98,160.86;420.56,162.05;420.56,162.05;420.56,162.05;420.56,162.05;419.37,162.05;417.58,162.65;415.19,162.05;414.6,162.05;414,162.05;414,162.05</gesture>\n" +
                "    </inklist>\n" +
                "  </ink>\n" +
                "    </add>\n" +
                "    <modify/>\n" +
                "    <delete/>\n" +
                "    </xfdf>"
        collabManager.importAnnotationCommand(testXfdf)
        collabManager.setCollabManagerListener { action, annotations, documentId, userName ->
            // local change, send info to server here
        }
    }

    override fun onDestroy() {
        super.onDestroy()
    }

    private fun createPdfViewerFragment(
        context: Context,
        fileUri: Uri,
        config: ViewerConfig
    ): CollabViewerTabHostFragment {
        return CollabViewerBuilder.withUri(fileUri)
            .usingConfig(config)
            .build(context)
    }

    private fun getViewerConfig(): ViewerConfig {
        val toolManagerBuilder = ToolManagerBuilder.from()
            .setAnnotationLayerEnabled(false)
            .setAutoSelect(true)
        return ViewerConfig.Builder()
            .multiTabEnabled(false)
            .fullscreenModeEnabled(false)
            .showCloseTabOption(false)
            .saveCopyExportPath(this.filesDir.absolutePath)
            .openUrlCachePath(this.filesDir.absolutePath)
            .toolManagerBuilder(toolManagerBuilder)
            .build()
    }
}
